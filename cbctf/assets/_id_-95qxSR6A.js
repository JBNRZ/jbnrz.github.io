import{r as g,j as e,m as h,B as x,e as W,u as Z,L as ee,t as v}from"./index-DcmwyZLT.js";import{a as te,u as ae,b as se}from"./contest-BoxN6aZy.js";import{c as A}from"./createReactComponent-BvB4Ztal.js";import{I as re}from"./IconUpload-BJIhE65C.js";import{I as F}from"./IconPlus-CmbdJV2w.js";import{I as ne}from"./IconEdit-Cxikt1Hi.js";import{I as O}from"./IconTrash-DxHNJIDs.js";import{I as ie}from"./IconX-BWSNq40F.js";import{I as le}from"./IconDeviceFloppy-BdT54yor.js";/**
 * @license @tabler/icons-react v3.29.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var S=A("outline","exclamation-circle","IconExclamationCircle",[["path",{d:"M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0",key:"svg-0"}],["path",{d:"M12 9v4",key:"svg-1"}],["path",{d:"M12 16v.01",key:"svg-2"}]]);/**
 * @license @tabler/icons-react v3.29.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var oe=A("outline","photo","IconPhoto",[["path",{d:"M15 8h.01",key:"svg-0"}],["path",{d:"M3 6a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v12a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3v-12z",key:"svg-1"}],["path",{d:"M3 16l5 -5c.928 -.893 2.072 -.893 3 0l5 5",key:"svg-2"}],["path",{d:"M14 14l1 -1c.928 -.893 2.072 -.893 3 0l3 3",key:"svg-3"}]]);function ce({contest:b,onSave:_,onCancel:w,onImageUpload:z}){var B,q,H;const[l,o]=g.useState(b||{title:"",description:"",image:"",status:"upcoming",startTime:"",endTime:"",participants:0,rules:[],prizes:[],timeline:[],_originalData:{prefix:"CTFHUB",size:4,hidden:!1,captcha:"",blood:!0}}),[f,N]=g.useState(""),[D,j]=g.useState({rule:null,prize:null,timeline:null}),[d,p]=g.useState({}),[T,C]=g.useState(l.image||""),i=g.useRef(null),s="w-full bg-black/70 border-2 border-neutral-600 rounded-md p-3 text-neutral-50 font-mono focus:border-geek-400 focus:outline-none transition-colors duration-200",u=`${s} min-h-[100px] resize-none`,c=`${s} appearance-none bg-[url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%236b7280" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>')] bg-no-repeat bg-right-[10px] bg-[length:20px]`,k=a=>{if(!a)return"";try{const t=new Date(a);if(isNaN(t.getTime()))return"";const r=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),m=String(t.getDate()).padStart(2,"0"),I=String(t.getHours()).padStart(2,"0"),E=String(t.getMinutes()).padStart(2,"0");return`${r}-${n}-${m}T${I}:${E}`}catch(t){return console.error("日期转换错误:",t),""}},U=a=>{var r;const t=(r=a.target.files)==null?void 0:r[0];if(t){if(z)z(t).then(n=>{n&&(o(m=>({...m,image:n})),C(n))}).catch(n=>{console.error("图片上传失败:",n)});else{const n=new FileReader;n.onload=m=>{const I=m.target.result;o(E=>({...E,image:I})),C(I)},n.readAsDataURL(t)}a.target.value=""}},R=()=>{var a;(a=i.current)==null||a.click()},y=a=>{const{name:t,value:r}=a.target;if(t==="startTime"||t==="endTime")if(r)try{const n=new Date(r);isNaN(n.getTime())?(console.error("无效的日期格式:",r),p(m=>({...m,[t]:"无效的日期格式"}))):(o(m=>({...m,[t]:n.toISOString()})),d[t]&&p(m=>({...m,[t]:""})))}catch(n){console.error("日期处理错误:",n),p(m=>({...m,[t]:"日期处理错误"}))}else o(n=>({...n,[t]:""}));else o(n=>({...n,[t]:r})),d[t]&&p(n=>({...n,[t]:""}))},M=()=>{f.trim()&&(o(a=>({...a,rules:[...a.rules||[],f]})),N(""))},L=(a,t)=>{const r=[...l.rules];r[a]=t,o(n=>({...n,rules:r})),j(n=>({...n,rule:null}))},V=a=>{const t=l.rules.filter((r,n)=>n!==a);o(r=>({...r,rules:t}))},K=()=>{o(a=>({...a,prizes:[...a.prizes||[],{amount:"$0",desc:""}]}))},P=(a,t,r)=>{const n=[...l.prizes];n[a]={...n[a],[t]:r},o(m=>({...m,prizes:n}))},X=a=>{const t=l.prizes.filter((r,n)=>n!==a);o(r=>({...r,prizes:t}))},Y=()=>{o(a=>({...a,timeline:[...a.timeline||[],{date:"",title:"",description:""}]}))},$=(a,t,r)=>{const n=[...l.timeline];n[a]={...n[a],[t]:r},o(m=>({...m,timeline:n}))},G=a=>{const t=l.timeline.filter((r,n)=>n!==a);o(r=>({...r,timeline:t}))},J=()=>{const a={};return l.title.trim()||(a.title="标题不能为空"),l.description.trim()||(a.description="描述不能为空"),l.startTime||(a.startTime="请选择开始时间"),l.endTime?new Date(l.startTime)>=new Date(l.endTime)&&(a.endTime="结束时间必须晚于开始时间"):a.endTime="请选择结束时间",p(a),Object.keys(a).length===0},Q=a=>{var t;if(a.preventDefault(),J())_(l);else{const r=Object.keys(d)[0];r&&((t=document.getElementsByName(r)[0])==null||t.scrollIntoView({behavior:"smooth",block:"center"}))}};return e.jsxs("form",{onSubmit:Q,className:"w-full max-w-[1200px] mx-auto space-y-6",children:[e.jsxs(h.div,{className:"relative w-full border-2 border-neutral-300 rounded-md overflow-hidden bg-black/50 backdrop-blur-[2px] p-8",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"比赛标题"}),e.jsx("input",{type:"text",name:"title",value:l.title,onChange:y,className:`${s} ${d.title?"border-red-400":""}`,required:!0}),d.title&&e.jsxs("p",{className:"mt-2 text-red-400 text-sm flex items-center gap-1",children:[e.jsx(S,{size:16}),d.title]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"描述"}),e.jsx("textarea",{name:"description",value:l.description,onChange:y,className:`${u} ${d.description?"border-red-400":""}`,required:!0}),d.description&&e.jsxs("p",{className:"mt-2 text-red-400 text-sm flex items-center gap-1",children:[e.jsx(S,{size:16}),d.description]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"背景图片"}),e.jsx("div",{className:"flex gap-4",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"w-full h-[200px] border-2 border-dashed border-neutral-600 rounded-md bg-black/30 flex items-center justify-center overflow-hidden relative group",children:T?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:T,alt:"比赛背景",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",children:e.jsx(x,{variant:"primary",size:"sm",align:"icon-left",icon:e.jsx(re,{size:16}),onClick:R,children:"更换图片"})})]}):e.jsx(x,{variant:"ghost",size:"sm",align:"icon-left",icon:e.jsx(oe,{size:48}),className:"flex-col !gap-3 !text-neutral-400",onClick:R,children:"点击上传背景图片"})}),e.jsx("input",{ref:i,type:"file",accept:"image/*",className:"hidden",onChange:U})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"状态"}),e.jsxs("select",{name:"status",value:l.status,onChange:y,className:c,required:!0,children:[e.jsx("option",{value:"upcoming",children:"即将开始"}),e.jsx("option",{value:"active",children:"进行中"}),e.jsx("option",{value:"ended",children:"已结束"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"开始时间"}),e.jsx("input",{type:"datetime-local",name:"startTime",value:k(l.startTime),onChange:y,className:`${s} ${d.startTime?"border-red-400":""}`,required:!0}),d.startTime&&e.jsxs("p",{className:"mt-2 text-red-400 text-sm flex items-center gap-1",children:[e.jsx(S,{size:16}),d.startTime]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"结束时间"}),e.jsx("input",{type:"datetime-local",name:"endTime",value:k(l.endTime),onChange:y,className:`${s} ${d.endTime?"border-red-400":""}`,required:!0}),d.endTime&&e.jsxs("p",{className:"mt-2 text-red-400 text-sm flex items-center gap-1",children:[e.jsx(S,{size:16}),d.endTime]})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-xl font-mono text-neutral-50 tracking-wider mb-4",children:"高级设置"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"Flag前缀"}),e.jsx("input",{type:"text",name:"_originalData.prefix",value:l._originalData.prefix,onChange:a=>o(t=>({...t,_originalData:{...t._originalData,prefix:a.target.value}})),className:s,placeholder:"例如: CBCTF"}),e.jsxs("p",{className:"mt-1 text-neutral-500 text-sm",children:["用于生成flag的前缀，例如：CBCTF","{flag}"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"团队人数上限"}),e.jsx("input",{type:"number",name:"_originalData.size",value:l._originalData.size,onChange:a=>o(t=>({...t,_originalData:{...t._originalData,size:parseInt(a.target.value)||1}})),min:"1",max:"10",className:s,placeholder:"团队最大人数"}),e.jsx("p",{className:"mt-1 text-neutral-500 text-sm",children:"每个参赛团队的最大人数"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"比赛验证码"}),e.jsx("input",{type:"text",name:"_originalData.captcha",value:l._originalData.captcha,onChange:a=>o(t=>({...t,_originalData:{...t._originalData,captcha:a.target.value}})),className:s,placeholder:"留空则不需要验证码"}),e.jsx("p",{className:"mt-1 text-neutral-500 text-sm",children:"加入比赛需要的验证码"})]}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"hidden-toggle",className:"w-5 h-5 bg-black border-2 border-neutral-600 rounded text-geek-400 focus:ring-geek-400",checked:l._originalData.hidden,onChange:a=>o(t=>({...t,_originalData:{...t._originalData,hidden:a.target.checked}}))}),e.jsx("label",{htmlFor:"hidden-toggle",className:"text-neutral-300 font-medium",children:"隐藏比赛"})]}),e.jsx("p",{className:"text-neutral-500 text-sm",children:"隐藏后比赛不会在首页显示，需要通过链接访问"}),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsx("input",{type:"checkbox",id:"blood-toggle",className:"w-5 h-5 bg-black border-2 border-neutral-600 rounded text-geek-400 focus:ring-geek-400",checked:l._originalData.blood,onChange:a=>o(t=>({...t,_originalData:{...t._originalData,blood:a.target.checked}}))}),e.jsx("label",{htmlFor:"blood-toggle",className:"text-neutral-300 font-medium",children:"启用一血奖励"})]}),e.jsx("p",{className:"text-neutral-500 text-sm",children:"对首个解出题目的队伍提供额外加分"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs(h.div,{className:"col-span-1 md:col-span-2 border-2 border-neutral-300 rounded-md bg-black/50 backdrop-blur-[2px] p-8",children:[e.jsx("h2",{className:"text-2xl font-mono text-neutral-50 tracking-wider mb-6",children:"比赛规则"}),e.jsxs("div",{className:"flex gap-2 mb-6",children:[e.jsx("input",{type:"text",value:f,onChange:a=>N(a.target.value),className:s,placeholder:"添加新规则...",onClick:M}),e.jsx(x,{variant:"primary",size:"sm",align:"icon-left",icon:e.jsx(F,{size:18}),onClick:M,children:"添加"})]}),e.jsx("div",{className:"space-y-4 text-neutral-300",children:(B=l.rules)==null?void 0:B.map((a,t)=>e.jsxs(h.div,{className:"flex items-center gap-4 p-2 rounded-md hover:bg-neutral-300/5 transition-colors duration-200",whileHover:{x:10},children:[e.jsx("span",{className:"text-geek-400 font-mono",children:(t+1).toString().padStart(2,"0")}),D.rule===t?e.jsx("input",{type:"text",value:a,onChange:r=>L(t,r.target.value),className:"flex-1 bg-black/70 border-2 border-geek-400 rounded-md p-2 text-neutral-50",autoFocus:!0,onBlur:()=>j(r=>({...r,rule:null})),onKeyPress:r=>r.key==="Enter"&&r.preventDefault()&&j(n=>({...n,rule:null}))}):e.jsx("p",{className:"flex-1",children:a}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"ghost",size:"icon",className:"!bg-transparent !text-geek-400 hover:!text-geek-300",onClick:()=>j(r=>({...r,rule:t})),children:e.jsx(ne,{size:18})}),e.jsx(x,{variant:"ghost",size:"icon",className:"!bg-transparent !text-red-400 hover:!text-red-300",onClick:()=>V(t),children:e.jsx(O,{size:18})})]})]},t))})]}),e.jsxs(h.div,{className:"border-2 border-neutral-300 rounded-md bg-black/50 backdrop-blur-[2px] p-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-2xl font-mono text-neutral-50 tracking-wider",children:"奖励设置"}),e.jsx(x,{variant:"primary",size:"sm",align:"icon-left",icon:e.jsx(F,{size:16}),onClick:K,children:"添加奖励"})]}),e.jsx("div",{className:"space-y-6",children:(q=l.prizes)==null?void 0:q.map((a,t)=>e.jsxs(h.div,{className:"p-4 border border-neutral-700 rounded-md bg-black/30",whileHover:{scale:1.02},children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsx("span",{className:`text-lg font-mono
                      ${t===0?"text-yellow-400":t===1?"text-neutral-300":t===2?"text-orange-400":"text-neutral-400"}
                    `,children:t===0?"1ST":t===1?"2ND":t===2?"3RD":`${t+1}TH`})}),e.jsx(x,{variant:"ghost",size:"icon",className:"!bg-transparent !text-red-400 hover:!text-red-300",onClick:()=>X(t),children:e.jsx(O,{size:18})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2 text-sm",children:"金额"}),e.jsx("input",{type:"text",value:a.amount,onChange:r=>P(t,"amount",r.target.value),className:"w-full bg-black/70 border-2 border-neutral-600 rounded-md p-2 text-neutral-50 font-mono focus:border-geek-400 focus:outline-none transition-colors duration-200"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2 text-sm",children:"描述"}),e.jsx("textarea",{value:a.desc||"",onChange:r=>P(t,"desc",r.target.value),className:"w-full bg-black/70 border-2 border-neutral-600 rounded-md p-2 text-neutral-50 text-sm min-h-[60px] resize-none focus:border-geek-400 focus:outline-none transition-colors duration-200"})]})]})]},t))})]})]}),e.jsxs(h.div,{className:"border-2 border-neutral-300 rounded-md bg-black/50 backdrop-blur-[2px] p-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-2xl font-mono text-neutral-50 tracking-wider",children:"时间线"}),e.jsx(x,{variant:"primary",size:"sm",align:"icon-left",icon:e.jsx(F,{size:16}),onClick:Y,children:"添加事件"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:(H=l.timeline)==null?void 0:H.map((a,t)=>e.jsxs(h.div,{className:"p-4 border border-neutral-700 rounded-md bg-black/30 relative",whileHover:{y:-5},children:[e.jsx(x,{variant:"ghost",size:"icon",className:"!bg-transparent !text-red-400 hover:!text-red-300 absolute top-2 right-2",onClick:()=>G(t),children:e.jsx(ie,{size:18})}),e.jsxs("div",{className:"space-y-4 mt-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2 text-sm",children:"日期"}),e.jsx("input",{type:"datetime-local",value:k(a.date),onChange:r=>$(t,"date",r.target.value),className:"w-full bg-black/70 border-2 border-neutral-600 rounded-md p-2 text-neutral-50 font-mono focus:border-geek-400 focus:outline-none transition-colors duration-200",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2 text-sm",children:"标题"}),e.jsx("input",{type:"text",value:a.title,onChange:r=>$(t,"title",r.target.value),className:"w-full bg-black/70 border-2 border-neutral-600 rounded-md p-2 text-neutral-50 focus:border-geek-400 focus:outline-none transition-colors duration-200"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2 text-sm",children:"描述"}),e.jsx("textarea",{value:a.description,onChange:r=>$(t,"description",r.target.value),className:"w-full bg-black/70 border-2 border-neutral-600 rounded-md p-2 text-neutral-50 text-sm min-h-[60px] resize-none focus:border-geek-400 focus:outline-none transition-colors duration-200"})]})]})]},t))})]}),e.jsxs("div",{className:"flex justify-end gap-4 mt-8",children:[e.jsx(x,{variant:"ghost",size:"sm",onClick:w,children:"取消"}),e.jsx(x,{variant:"primary",size:"sm",align:"icon-left",icon:e.jsx(le,{size:18}),type:"submit",children:"保存更改"})]})]})}function je(){const{id:b}=W(),_=Z(),[w,z]=g.useState(null),[l,o]=g.useState(!0),[f,N]=g.useState("");g.useEffect(()=>{D()},[b]);const D=async()=>{var i;o(!0);try{const s=await te(parseInt(b));if(s.code===200){const u={title:s.data.name,description:s.data.desc,image:s.data.avatar,status:j(s.data),startTime:s.data.start,endTime:d(s.data.start,s.data.duration),participants:s.data.users,rules:s.data.rules||[],prizes:((i=s.data.prizes)==null?void 0:i.map(c=>({amount:c.amount,desc:c.desc})))||[],timeline:s.data.timelines?s.data.timelines.map(c=>({date:c.date,title:c.title,description:c.desc})):[],_originalData:{prefix:s.data.prefix,size:s.data.size,hidden:s.data.hidden,captcha:s.data.captcha,blood:s.data.blood}};z(u)}else N(s.msg||"获取比赛信息失败")}catch(s){N("获取比赛信息失败"),console.error(s)}finally{o(!1)}},j=i=>{const s=new Date().getTime()/1e3,u=new Date(i==null?void 0:i.start).getTime()/1e3,c=i==null?void 0:i.duration,k=u+c;return s<u?"upcoming":s>k?"ended":"active"},d=(i,s)=>{if(!i||!s)return"";const u=new Date(i);return new Date(u.getTime()+s*1e3).toISOString()},p=async i=>{try{const s=await ae(b,i);if(s.code===200)return v.success({description:"更新比赛封面成功"}),s.data.avatar;v.danger({description:s.msg||"更新封面失败"})}catch(s){console.error("更新封面失败:",s),v.danger({description:"更新封面失败"})}return null},T=async i=>{try{const s={name:i.title,desc:i.description,prefix:i._originalData.prefix,size:i._originalData.size,hidden:i._originalData.hidden,captcha:i._originalData.captcha,blood:i._originalData.blood,start:new Date(i.startTime).toISOString(),duration:Math.floor((new Date(i.endTime)-new Date(i.startTime))/1e3),status:i.status,timelines:i.timeline.map(c=>({date:c.date?new Date(c.date).toISOString():"",title:c.title,desc:c.description})),rules:i.rules,prizes:i.prizes.map(c=>({amount:c.amount,desc:c.desc}))},u=await se(parseInt(b),s);u.code===200?(v.success({description:"更新比赛信息成功"}),await D()):v.danger({description:u.msg||"更新比赛信息失败"})}catch(s){console.error("更新比赛信息失败:",s),v.danger({description:"更新比赛信息失败"})}},C=()=>{_("/admin/contests")};return l?e.jsx(ee,{}):f?e.jsx("div",{className:"text-red-500",children:f}):w?e.jsx(ce,{contest:w,onSave:T,onCancel:C,onImageUpload:p}):null}export{je as default};
